<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Employees</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="/css/common.css">
    <link rel="stylesheet" type="text/css" href="/css/nav-sidebar.css">
    <link rel="stylesheet" type="text/css" href="/css/home-common.css">
    <link rel="stylesheet" type="text/css" href="/css/grid-common.css">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body class="homepage-body">
<div class="top-bar">
    <h1 class="logo">
        <a href="/home" class="logo-link">
            <img src="/images/only-logo.png" alt="Inventorize Logo" class="logo-icon">
            <span class="logo-text">inventorize</span>
        </a>
    </h1>
    <div class="btn-group">
        <a th:href="@{/logout}" class="button">Logout</a>
    </div>
</div>
<div class="main-layout">
    <aside class="sidebar">
        <div class="sidebar-top">
            <div class="sidebar-user-info">
                <div class="sidebar-user-name" th:text="${user.firstName + ' ' + user.lastName}">John Doe</div>
                <div class="sidebar-user-role" th:text="${user.role.displayName}">Admin</div>
            </div>
            <div class="sidebar-section top-section">
                <a class="sidebar-btn rounded-btn home-btn" href="/home">Home</a>
            </div>
            <div class="sidebar-divider"></div>
            <div class="sidebar-section middle-section">
                <div class="sidebar-section-label">Business</div>
                <a class="sidebar-btn rounded-btn" th:href="@{'/businesses/' + ${business.id} + '/products'}">Products</a>
                <a class="sidebar-btn rounded-btn" th:href="@{'/businesses/' + ${business.id} + '/employees'}" sec:authorize="hasRole('ROLE_ADMIN') or hasRole('ROLE_MANAGER')">Employees</a>
            </div>
            <div class="sidebar-divider"></div>
            <div class="sidebar-section middle-section">
                <div class="sidebar-section-label">Profile settings</div>
                <a class="sidebar-btn rounded-btn" th:href="@{'/users/' + ${user.id} + '/profile'}">Edit Profile</a>
            </div>
        </div>
        <div class="sidebar-bottom">
            <div class="sidebar-divider"></div>
            <div class="sidebar-section bottom-section" sec:authorize="hasRole('ROLE_ADMIN')">
                <div class="sidebar-section-label">Admin</div>
                <a class="sidebar-btn rounded-btn" href="/businesses">Businesses</a>
                <a class="sidebar-btn rounded-btn" href="/users">Users</a>
            </div>
        </div>
    </aside>
    <main class="content-area">
        <div class="products-container">
            <div class="products-header">
                <div class="header-buttons">
                    <a th:href="@{/users/new}" class="add-btn">Add</a>
                    <button type="button" class="delete-btn" id="deleteBtn">Delete</button>
                </div>
                <h2 class="products-title">Employees</h2>
            </div>
            <div class="products-grid">
                <div class="grid-header">
                    <div class="grid-cell header-cell">#</div>
                    <div class="grid-cell header-cell">First Name</div>
                    <div class="grid-cell header-cell">Last Name</div>
                    <div class="grid-cell header-cell">Email</div>
                    <div class="grid-cell header-cell">Phone Number</div>
                </div>
                <label class="grid-row" th:each="employee, iterStat : ${employees}">
                    <input type="radio" name="selectedEmployee" class="row-radio" th:value="${employee.id}">
                    <div class="grid-cell row-number" th:text="${iterStat.count}"></div>
                    <div class="grid-cell">
                        <span class="cell-text" th:text="${employee.firstName}">John</span>
                    </div>
                    <div class="grid-cell">
                        <span class="cell-text" th:text="${employee.lastName}">Doe</span>
                    </div>
                    <div class="grid-cell">
                        <span class="cell-text" th:text="${employee.email}">john.doe@example.com</span>
                    </div>
                    <div class="grid-cell">
                        <span class="cell-text" th:text="${employee.phoneNumber}">+1234567890</span>
                    </div>
                </label>
            </div>
        </div>
    </main>
</div>
<script type="text/javascript" th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        // Get business ID from Thymeleaf
        const businessId = /*[[${business.id}]]*/ null;

        if (!businessId) {
            console.error('Business ID is missing!');
            return;
        }

        // Get CSRF token
        const csrfMeta = document.querySelector('meta[name="_csrf"]');
        const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');

        if (!csrfMeta || !csrfHeaderMeta) {
            console.error('CSRF tokens are missing!');
            return;
        }

        const csrfToken = csrfMeta.content;
        const csrfHeader = csrfHeaderMeta.content;

        const deleteBtn = document.getElementById('deleteBtn');

        if (!deleteBtn) {
            console.error('Delete button not found');
            return;
        }

        // Delete button functionality
        deleteBtn.addEventListener('click', function() {
            const selectedRow = document.querySelector('.row-radio:checked');
            if (!selectedRow) {
                alert('Please select an employee to delete');
                return;
            }

            const employeeId = selectedRow.value;
            const rowToDelete = selectedRow.closest('.grid-row');

            if (confirm('Are you sure you want to delete this employee?')) {
                // Use POST with _method=DELETE for Spring's HiddenHttpMethodFilter
                const deleteFormData = new FormData();
                deleteFormData.append('_method', 'DELETE');
                deleteFormData.append('_csrf', csrfToken);

                fetch('/businesses/' + businessId + '/employees/' + employeeId, {
                    method: 'POST',
                    headers: {
                        [csrfHeader]: csrfToken
                    },
                    body: deleteFormData,
                    redirect: 'manual'
                })
                    .then(response => {
                        // Spring returns redirect (302) on success
                        // With redirect: 'manual', we get the redirect response
                        // Check if it's a redirect (status 0 or 302) or success (2xx)
                        const status = response.status;
                        const isRedirect = status === 0 || status === 302 || response.type === 'opaqueredirect';
                        const isSuccess = status >= 200 && status < 300;

                        if (isRedirect || isSuccess || response.redirected) {
                            // Success - remove row from DOM dynamically
                            if (rowToDelete) {
                                rowToDelete.remove();
                            }

                            // Update row numbers after deletion
                            const employeeRows = Array.from(document.querySelectorAll('.grid-row'));
                            employeeRows.forEach(function(row, index) {
                                const rowNumberCell = row.querySelector('.row-number');
                                if (rowNumberCell) {
                                    rowNumberCell.textContent = (index + 1).toString();
                                }
                            });

                            // Unselect any selected radio button
                            const remainingSelected = document.querySelector('.row-radio:checked');
                            if (remainingSelected) {
                                remainingSelected.checked = false;
                            }
                        } else if (status >= 400) {
                            // Error - show message
                            response.text().then(text => {
                                console.error('Delete failed:', status, text);
                                alert('Failed to delete employee. Please try again.');
                            }).catch(() => {
                                alert('Failed to delete employee. Please try again.');
                            });
                        } else {
                            // Unknown status - assume success (might be redirect)
                            if (rowToDelete) {
                                rowToDelete.remove();
                            }
                            const employeeRows = Array.from(document.querySelectorAll('.grid-row'));
                            employeeRows.forEach(function(row, index) {
                                const rowNumberCell = row.querySelector('.row-number');
                                if (rowNumberCell) {
                                    rowNumberCell.textContent = (index + 1).toString();
                                }
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting employee:', error);
                        alert('An error occurred while deleting the employee.');
                    });
            }
        });
    });
</script>
<footer class="copyright">
    <p>Â© 2025 inventorize. All rights reserved.</p>
</footer>
</body>
</html>
